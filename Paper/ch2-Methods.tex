\chapter{Methods \label{Chapter-Methods}}

\section{Dataset}

The data we used in this work came from the Multi-Ethnic Study of Atherosclerosis (MESA) \cite{chen2015racial}, a large-scale sleep study aimed to investigate correlations between sleep quality, cardiovescular health, SDB, and other factors across different ethnic groups.
Over 6,800 men and women from six different US communities were approached in the initial examination. For the final sleep exam ten years later, 288 participants were ineligible\footnote{due to undergoing apnea treatment, living to far away, or other reasons}, roughly 2,700 were not contacted, and roughly 1,500 refused to participate. From the 2,261 participants undergoing the sleep exam, 2,060 had full-night PSG recordings, 2,156 had actigraphy data, and 2,240 completed a sleep questionnaire.

For the sleep event scoring, we used the automatic Somnolyzer system \todo{cite}, which scored events based on the recommended criteria from the American Academy of Sleep Medicine (AASM) \todo{cite}: apnea events were defined as a 90\% or greater reduction in airflow for at least 10 seconds, while hypopnea events were defined as a 30\% or greater reduction in airflow for at least 10 seconds, with either a $\geq 3\%$ oxygen desaturation or an associated arousal. \todo{obstructive vs central vs mixed?}

As SDB events manifest differently accross sleep stages, we used a modified version of the hypnogram prediction model from Bakker et al. \cite{bakker2021estimating}, that used only PPG signals, ensuring that our model works doesn't depend on signals outside of the finger-worn PPG sensor setup. Comparing the predicted hypnogram\footnote{Bakker's model combined N1 and N2 stages into one, resulting in four stages: Wake, N1/N2, N3, and REM. For calculating the Kappa, Somnolyzer scorings were adjusted to the same format} with the Somnolyzer hypnogram, we achieved a Cohen's Kappa of 0.55, showing moderate agreement.

Filtering the MESA participants for those with PPG and SpO2 data, Somnolyzer scorings, and available predicted hypnograms, we ended up with a dataset size of 1,880 participants. Table \ref{tab:dataset-demographics} shows the demographic distribution and sleep times of our dataset subset together with the generated folds.
To assess SDB severity, the AHI is often categorized into four classes. These so called severity classes are defined as follows: Normal (AHI $<$ 5), Mild (5 $\le$ AHI $<$ 15), Moderate (15 $\le$ AHI $<$ 30), and Severe (AHI $\ge$ 30).
Table \ref{tab:dataset-ahi} shows their distribution.
The amount of different apnea classes is shown in table \ref{tab:dataset-apnea-classes}.

\renewcommand{\arraystretch}{1.5}
\begin{table}
    \centering
    \begin{tabular}{p{1cm} p{1cm} p{1.7cm} p{1.7cm} p{1.7cm} p{1.7cm}}
        Fold & N & Age \newline (years) & BMI \newline ($kg/m^2$) & Sex \newline (N male) & TST \newline (h) \\
        \hline
        1 & 470 & $70\pm9$ \newline \textbf{[55, 90]} & $29\pm5$ \newline \textbf{[19, 48]} & 228 \newline (48.5\%) & $6.2\pm1.36$ \newline \textbf{[1.7, 10]} \\
        2 & 470 & $70\pm9$ \newline \textbf{[54, 90]} & $29\pm6$ \newline \textbf{[17, 56]} & 208 \newline (44.3\%) & $6.2\pm1.36$ \newline \textbf{[1.6, 10]} \\
        3 & 470 & $69\pm9$ \newline \textbf{[55, 90]} & $29\pm5$ \newline \textbf{[16, 50]} & 229 \newline (48.7\%) & $6.2\pm1.47$ \newline \textbf{[0.7, 10]} \\
        4 & 470 & $69\pm9$ \newline \textbf{[55, 90]} & $28\pm5$ \newline \textbf{[17, 50]} & 210 \newline (44.7\%) & $6.2\pm1.32$ \newline \textbf{[0.9, 10]} \\
        \hline
        Full & 1880 & $69\pm9$ \newline \textbf{[54, 90]} & $29\pm6$ \newline \textbf{[16, 56]} & 875 \newline (46.5\%) & $6.2\pm1.38$ \newline \textbf{[0.7, 10]} \\
    \end{tabular}
    \caption{Demographic distribution and sleep times of the MESA dataset subset. Format for Age, BMI, and TST is mean $\pm$ std [min, max]. \label{tab:dataset-demographics}}
\end{table}

\renewcommand{\arraystretch}{1.5}
\begin{table}
    \centering
    \begin{tabular}{p{1cm} p{2cm} p{1.5cm} p{1.5cm} p{1.5cm} p{1.5cm}}
         &  & \multicolumn{4}{c}{Severity Class} \\
        \cline{3-6}
        Fold & AHI & normal & mild & moderate & severe \\
        \hline
        1 & $22.2\pm18.3$ \newline \textbf{[0.4, 100]} & 61 & 153 & 136 & 120 \\
        2 & $22.0\pm18.3$ \newline \textbf{[0.3, 93]} & 61 & 151 & 134 & 124 \\
        3 & $21.3\pm17.1$ \newline \textbf{[0.4, 95]} & 61 & 151 & 138 & 120 \\
        4 & $22.0\pm18.3$ \newline \textbf{[0.4, 107]} & 61 & 150 & 140 & 119 \\
        \hline
        Full & $21.9\pm18.0$ \newline \textbf{[0.3, 107]} & 244 & 605 & 548 & 483 \\
    \end{tabular}
    \caption{AHI and severity class distribution accross folds and full dataset subset.\todo{better use [25\%,75\%] interval instead of [min, max]?} Format for the AHI is mean $\pm$ std [min, max]. \label{tab:dataset-ahi}}
\end{table}

\renewcommand{\arraystretch}{1.5}
\begin{table}
    \centering
    \begin{tabular}{p{1cm} p{1.7cm} p{1.7cm} p{1.7cm} p{1.8cm}}
        Fold & obstructive \newline apnea & central \newline apnea & mixed \newline apnea & hypopnea \\
        \hline
        1 & 15k (24\%) & 4k (7\%) & 1k (2\%) & 42k (67\%) \\
        2 & 16k (26\%) & 4k (6\%) & 1k (2\%) & 42k (66\%) \\
        3 & 15k (24\%) & 3k (6\%) & 1k (2\%) & 41k (67\%) \\
        4 & 17k (26\%) & 4k (6\%) & 1k (2\%) & 42k (66\%) \\
        \hline
        Full & 63k (25\%) & 16k (6\%) & 5k (2\%) & 167k (67\%) \\
    \end{tabular}
    \caption{Total number of apnea events. \label{tab:dataset-apnea-classes}}
\end{table}

\section{Preprocessing}

\begin{itemize}
    \item PPG [256Hz], SpO2 [1Hz], Hypnogram [1Hz]
    \item For PPG: Statistical Analysis, Denoising, VAE?, Conv-Block
\end{itemize}

\section{Model Architecture}

\begin{itemize}
    \item U-Net (with PPG Conv-Block), Batch-Norm, Attention, ...
    \item Output: Detection at 1Hz - Event vs No Event
    \item TODO Next model then classifies into SDB classes
\end{itemize}

\section{Training and Evaluation}

\begin{itemize}
    \item Training Parameters (Optimizer, LR, BS, ...) and Setup (Machines, ...)
    \item Seed and Cross-Validation (mainly balanced for AHI severity, but with seed 42 we got a good distribution fo demographic data in the folds)
    \item Train on 30min (?) segments. For Testing: Concat 30min Windows with Overlap for full night result.
    \item Correct results (like Olsen, 10sec minimum event and distance between events)
    \item Event-based metrics (Se, Pr, F1) and when to count TP, TN, FP, FN
    \item AHI-based metric (Linear Correlation, Severity Classes, Near-Boundary Double-Classification)
\end{itemize}

% \subsection*{Subsection}